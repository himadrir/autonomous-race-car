<launch>
  <arg name="run_rtabmap_stereo" default="true"/>
  <arg name="run_rtabmap_lidar" default="false"/>
  <arg name="view_map" default="false"/>

  <arg name="MaxObstacleHeight" default="0.8"/>





  <group if="$(arg run_rtabmap_stereo)">
        <!-- import the launch file for sim from different workspace here -->
        <include file="/home/himadrir/sim_ws/src/audubon_gazebo/launch/IMS.launch"/>

        <node pkg="tf" type="static_transform_publisher" name="camera" args="0 -0.035 0 0.5 -0.5 0.5 -0.5 /car_1_camera /left_camera_optical_frame  100"/>

        <node pkg="nodelet" type="nodelet" name="stereo_nodelet" args="manager"/>
        <node  pkg="stereo_image_proc" type="stereo_image_proc" name="stereo_image_proc">
             <remap from="left/image_raw"    to="/car_1/camera/left/image_raw"/>
             <remap from="left/camera_info"  to="/car_1/camera/left/camera_info"/>
             <remap from="right/image_raw"   to="/car_1/camera/right/image_raw"/>
             <remap from="right/camera_info" to="/car_1/camera/right/camera_info"/>

             <param name="approximate_sync" type="bool" value="true"/>
             <param name="queue_size" type="int" value="10"/>
             <param name="disparity_range" type="int" value="128"/>
        </node>

    <!-- Stereo Odometry -->
       <node pkg="rtabmap_ros" type="stereo_odometry" name="stereo_odometry" output="screen">
              <remap from="left/image_rect"         to="/left/image_rect"/>
              <remap from="right/image_rect"        to="/right/image_rect"/>
              <remap from="right/camera_info"       to="/car_1/camera/right/camera_info"/>
              <remap from="left/camera_info"        to="/car_1/camera/left/camera_info"/>

              <param name="frame_id" type="string" value="car_1_camera"/>
              <param name="odom_frame_id" type="string" value="odom"/>
              <param name="approx_sync" type="bool" value="false"/>
              <param name="queue_size" type="int" value="5"/>
              <param name="stereo" type="bool" value="true"/>

              <param name="Odom/MinInliers" type="string" value="10"/>
              <param name="Odom/RoiRatios" type="string" value="0.03 0.03 0.04 0.04"/>
       </node>

        <node pkg="rtabmap_ros" type="rtabmap" name="rtabmap" output="screen" args="--delete_db_on_start">
                <param name="frame_id" type="string" value="car_1_camera"/>
                <param name="subscribe_stereo" type="bool" value="true"/>
                <param name="subscribe_depth"  type="bool" value="false"/>
                <param name="approx_sync"      type="bool" value="false"/>

                <remap from="left/image_rect"         to="/left/image_rect"/>
                <remap from="right/image_rect"        to="/right/image_rect"/>
                <remap from="right/camera_info"       to="/car_1/camera/right/camera_info"/>
                <remap from="left/camera_info"        to="/car_1/camera/left/camera_info"/>

                <remap from="odom" to="/odom"/>
                <remap from="grid_map" to="/rtabmap/map"/>

                <param name="queue_size" type="int" value="30"/>
                <param name="grid_unknown_space_filled" type="bool"   value="true"/>

             <!-- RTAB-Map's parameters -->
                <param name="Rtabmap/DetectionRate"		type="string" value="5"/>
                <param name="Kp/DetectorStrategy"			type="string" value="0"/>
                <param name="Reg/Strategy"				type="string" value="0"/>
                <param name="Vis/MinInliers" type="string" value="18"/>
                <param name="Grid/MaxObstacleHeight" type="string" value="$(arg MaxObstacleHeight)" />
                <param name="Grid/NoiseFilteringMinNeighbors" type="string" value="5"/>
                <param name="Optimizer/Strategy"			type="string" value="1"/>
                <param name="Optimizer/Robust"			type="string" value="true"/>
        </node>
      <group ns="rtabmap">
          <node pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz" output="screen">
             <param name="subscribe_stereo"    type="bool"   value="true"/>
             <param name="subscribe_odom_info" type="bool"   value="true"/>
             <param name="queue_size"          type="int"    value="10"/>
             <param name="frame_id"            type="string" value="car_1_camera"/>
             <remap from="right/image_rect"         to="/right/image_rect"/>
             <remap from="left/image_rect"          to="/left/image_rect"/>
             <remap from="right/camera_info"        to="/car_1/camera/right/camera_info"/>
             <remap from="left/camera_info"         to="/car_1/camera/left/camera_info"/>
             <remap from="odom_info"         to="/odom_info"/>
             <remap from="odom"              to="/odom"/>
          </node>
        </group>
  </group>

  <!-- RTABMAP using lidar -->
  <group if ="$(arg run_rtabmap_lidar)">
    <node pkg="rtabmap_ros" type="rtabmap" name="rtabmap" output="screen" args="-d">

      <param name="subscribe_scan"                  value="true"/>
      <param name="subscribe_rgb"                   value="false"/>
      <param name="subscribe_depth"                 value="false"/>
      <param name="frame_id"                        value="car_1_base_link"/>
      <param name="odom_frame_id"                   value="odom"/>
      <param name="wait_for_transform_duration"     value="1"/>
      <param name="odom_tf_linear_variance"         value="0.01"/>
      <param name="odom_tf_angular_variance"        value="0.05"/>

      <!-- RTAB-Map parameters -->
      <param name="Reg/Strategy"                    value="1"/>    <!-- 1 for lidar -->
      <param name="Reg/Force3DoF"                   value="true"/> <!-- 2d slam -->
      <param name="RGBD/NeighborLinkRefining"       value="true"/> <!-- odometry correction with scans -->

      <remap from="scan"    to="/car_1/scan"/>

    </node>

    <!-- just for visualization -->
    <node pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz" output="screen"/>
  </group>

  <!-- to use RTABMAP-database-viewer, leave args empty -->
  <group if="$(arg view_map)" >
    <node pkg="rtabmap_ros" type="rtabmap" name="rtabmap" output="screen">
                <param name="frame_id" type="string" value="car_1_camera"/>
                <param name="subscribe_stereo" type="bool" value="true"/>
                <param name="subscribe_depth"  type="bool" value="false"/>
                <param name="approx_sync"      type="bool" value="false"/>

                <remap from="left/image_rect"         to="/left/image_rect"/>
                <remap from="right/image_rect"        to="/right/image_rect"/>
                <remap from="right/camera_info"       to="/car_1/camera/right/camera_info"/>
                <remap from="left/camera_info"        to="/car_1/camera/left/camera_info"/>

                <remap from="odom" to="/odom"/>
                <remap from="grid_map" to="/rtabmap/map"/>
        </node>
  </group>


</launch>